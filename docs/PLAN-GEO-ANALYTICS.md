# üåç PLAN DE IMPLEMENTACI√ìN: Geo-Analytics Dashboard

**Fecha de Creaci√≥n:** 2 de Octubre 2025  
**Objetivo:** Sistema de tracking geogr√°fico de visitantes y an√°lisis de conversi√≥n por pa√≠s  
**Tiempo Estimado Total:** 12-15 horas  
**Nivel de Calidad:** Enterprise Premium (consistente con Dashboard de Compras)

---

## üìã √çNDICE DE FASES

```
INFRAESTRUCTURA (Fases 1-2) ‚Üí 4-5 horas  ‚Üí Base de datos + Middleware [‚è≥ Pendiente]
VISUALIZACI√ìN (Fases 3-4)   ‚Üí 5-6 horas  ‚Üí Tab + Mapa + M√©tricas [‚è≥ Pendiente]
AVANZADO (Fase 5)           ‚Üí 2-3 horas  ‚Üí Campa√±as + UTM Tracking [‚è≥ Pendiente]
FINALIZACI√ìN (Fase 6)       ‚Üí 1-2 horas  ‚Üí Testing + Docs [‚è≥ Pendiente]
```

**PROGRESO GLOBAL: 0% (0 de 6 fases completadas)**

---

## üéØ VISI√ìN GENERAL

### Problema a Resolver:

**"Facebook dice que envi√≥ el contenido a 10,000 usuarios espa√±oles, ¬øcu√°ntos de esos 10,000 se conectaron a mi web y cu√°ntos compraron?"**

### Contexto del Negocio:

Actualmente, cuando pagas publicidad en Facebook, Google Ads o Instagram, recibes m√©tricas de la plataforma (reach, impressions, clicks), pero **NO tienes visibilidad de:**

1. ¬øCu√°ntos de esos "clicks" realmente llegaron a tu web?
2. ¬øDe qu√© pa√≠ses vinieron exactamente?
3. ¬øCu√°nto tiempo permanecieron?
4. ¬øQu√© p√°ginas visitaron?
5. ¬øCu√°ntos compraron al final?

### Soluci√≥n Propuesta:

Sistema h√≠brido de tracking que combina **3 fuentes de datos**:

1. **Tracking en tu servidor (Next.js Middleware)**
   - Captura IP de cada visitante
   - Obtiene geolocalizaci√≥n precisa (pa√≠s, ciudad, coordenadas)
   - Guarda UTM parameters de las campa√±as
   - No depende de cookies bloqueables

2. **Datos de Stripe**
   - Confirma qu√© visitantes compraron
   - Valida pa√≠s con billing address
   - Calcula revenue por pa√≠s/campa√±a

3. **Cookies de sesi√≥n**
   - Vincula m√∫ltiples visitas del mismo usuario
   - Rastrea navegaci√≥n completa (landing ‚Üí exit)
   - Calcula tiempo en sitio

### Flujo Completo del Sistema:

```
Usuario ve anuncio Facebook (Espa√±a)
         ‚Üì
[CLICK] utm_source=facebook&utm_campaign=spain_2025
         ‚Üì
Tu Middleware captura:
  ‚Ä¢ IP: 89.116.30.133
  ‚Ä¢ Pa√≠s: Espa√±a (ES)
  ‚Ä¢ Ciudad: Madrid
  ‚Ä¢ UTM params guardados
  ‚Ä¢ Session ID generado
         ‚Üì
Usuario navega tu web
  ‚Ä¢ P√°ginas visitadas: 5
  ‚Ä¢ Tiempo en sitio: 3min 45s
  ‚Ä¢ Producto visto: "Pro Anual"
         ‚Üì
Usuario compra (Stripe Checkout)
         ‚Üì
Webhook de Stripe actualiza:
  ‚Ä¢ visitor_tracking.purchased = TRUE
  ‚Ä¢ Vincula purchase_id
  ‚Ä¢ Confirma pa√≠s con billing_address
         ‚Üì
Dashboard muestra:
  ‚úÖ Facebook Reach: 10,000
  ‚úÖ Visitas reales: 3,245 (32.45% CTR)
  ‚úÖ Compras: 23 (0.71% conversion)
  ‚úÖ Revenue Espa√±a: $6,789
```

---

## üìä M√âTRICAS CLAVE QUE RESOLVER√ÅS

### Pregunta 1: "¬øCu√°ntos visitantes recibo por pa√≠s?"
**Respuesta:** Tabla con pa√≠ses ordenados por visitas, mapa interactivo con pins.

### Pregunta 2: "¬øQu√© pa√≠ses compran m√°s?"
**Respuesta:** Conversion rate por pa√≠s, colores en mapa (verde/amarillo/rojo).

### Pregunta 3: "¬øMi campa√±a de Facebook Espa√±a funciona?"
**Respuesta:** 
- Facebook dice: 10,000 reach
- Tu web registra: 3,245 visitas (32.45% CTR)
- Compras: 23 (0.71% conversion)
- CAC: $12.50
- ROAS: 2.8x

### Pregunta 4: "¬øVale la pena publicidad en M√©xico?"
**Respuesta:**
- Visitas M√©xico: 1,567
- Compras: 12
- Conversion: 0.77%
- Revenue: $3,456
- Comparativa con otros pa√≠ses

---

## üîß FASE 1: BASE DE DATOS Y ESQUEMA

**Tiempo:** 1-2 horas  
**Estado:** ‚è≥ Pendiente  
**Prioridad:** CR√çTICA

### Objetivo:
Crear la infraestructura de base de datos para almacenar y consultar eficientemente millones de visitas.

### Tabla 1: `visitor_tracking`

**Prop√≥sito:** Registrar CADA visita a tu web con m√°xima informaci√≥n.

**Campos principales:**
- **Identificaci√≥n:** session_id √∫nico, fingerprint opcional
- **Red:** ip_address
- **Geolocalizaci√≥n:** country (ISO code), country_name, city, region, latitude, longitude, postal_code
- **Dispositivo:** user_agent, browser, os, device_type (desktop/mobile/tablet)
- **Origen:** referer, utm_source, utm_medium, utm_campaign, utm_term, utm_content
- **Navegaci√≥n:** landing_page, exit_page, pages_visited, time_on_site (segundos)
- **Conversi√≥n:** purchased (boolean), purchase_id (FK), purchase_amount_cents, purchase_date
- **Timestamps:** first_visit_at, last_visit_at, created_at, updated_at

**√çndices cr√≠ticos para performance:**
- Por pa√≠s (queries "mostrar Espa√±a")
- Por purchased (queries "solo compradores")
- Por utm_campaign (queries "campa√±a X")
- √çndice compuesto: (utm_source, utm_campaign, country, purchased) para analytics de campa√±as
- Por fecha para filtros de rango

**Volumen esperado:** 
- Sitio peque√±o: ~1,000 visitas/mes = 12K/a√±o
- Sitio mediano: ~10,000 visitas/mes = 120K/a√±o
- Sitio grande: ~100,000 visitas/mes = 1.2M/a√±o

### Tabla 2: `utm_campaigns`

**Prop√≥sito:** Gestionar campa√±as publicitarias y sus metas.

**Campos principales:**
- **Identificaci√≥n:** campaign_name, utm_source, utm_medium, utm_campaign
- **Targeting:** target_countries (array de c√≥digos ISO)
- **Budget:** budget_cents, status (active/paused/completed)
- **Metas:** reach_goal, visits_goal, purchases_goal
- **Datos externos:** external_reach (del dashboard de FB/Google), external_impressions, external_clicks, external_spend_cents
- **Metadata:** notes, created_by, start_date, end_date

**Uso:**
Cuando creas una campa√±a en Facebook "Spain Targeting 2025":
1. Creas registro en `utm_campaigns`
2. Defines: target_countries = ["ES"], reach_goal = 10,000, budget = $500
3. Facebook te da: external_reach = 10,000, external_clicks = 3,500
4. Tu sistema calcula autom√°ticamente: visitas reales, compras, CAC, ROAS

### Vista Materializada 1: `campaign_performance`

**Prop√≥sito:** Pre-calcular m√©tricas complejas de campa√±as para dashboards r√°pidos.

**M√©tricas calculadas:**
- **Funnel completo:** external_reach ‚Üí total_visits ‚Üí total_purchases
- **Tasas:** reach_to_visit_rate (CTR real), visit_to_purchase_rate (conversion)
- **Financieras:** cac_cents (costo por cliente), roas (retorno sobre inversi√≥n)
- **Cobertura:** countries_reached, total_revenue_cents

**Beneficio:** En lugar de calcular estas m√©tricas en cada request (lento), se pre-calculan y se refrescan cada hora o manualmente.

### Vista Materializada 2: `country_stats`

**Prop√≥sito:** Estad√≠sticas agregadas por pa√≠s para el mapa y la tabla.

**M√©tricas calculadas:**
- **Volumen:** total_visits, total_purchases
- **Revenue:** total_revenue_cents
- **Engagement:** conversion_rate, avg_time_on_site, avg_pages_visited
- **Frescura:** last_visit

**Uso en UI:**
- Mapa: colorear pa√≠ses seg√∫n conversion_rate
- Tabla: ordenar pa√≠ses por cualquier m√©trica
- Cards: "Top 5 pa√≠ses por revenue"

### Triggers y Funciones:

**Trigger 1: `update_updated_at_column`**
- Actualiza autom√°ticamente el campo `updated_at` en cada UPDATE
- Beneficio: No tener que recordar hacerlo manualmente

**Funci√≥n: `refresh_campaign_performance()`**
- Refresca la vista materializada bajo demanda
- Se puede ejecutar manualmente o con un cron job cada hora

---

## üöÄ FASE 2: MIDDLEWARE Y TRACKING

**Tiempo:** 2-3 horas  
**Estado:** ‚è≥ Pendiente  
**Dependencias:** Fase 1

### Objetivo:
Capturar autom√°ticamente datos de CADA visitante sin afectar la velocidad del sitio.

### Componente 1: Next.js Middleware

**Qu√© es:** Un interceptor que se ejecuta ANTES de que se sirva cualquier p√°gina.

**D√≥nde vive:** Archivo `middleware.ts` en la ra√≠z del proyecto.

**Qu√© captura:**

1. **IP del visitante:**
   - Usar funci√≥n `ipAddress()` de `@vercel/functions`
   - Ejemplo: "89.116.30.133"

2. **Geolocalizaci√≥n autom√°tica:**
   - Usar funci√≥n `geolocation()` de `@vercel/functions`
   - Vercel/Cloudflare ya saben la ubicaci√≥n por la IP
   - Sin latencia adicional (headers ya incluyen esta info)
   - Precisi√≥n: pa√≠s 99%, ciudad ~80%

3. **UTM Parameters:**
   - Leer de la URL: `?utm_source=facebook&utm_campaign=spain_2025`
   - Guardar TODOS los UTM (source, medium, campaign, term, content)

4. **User Agent:**
   - String completo del navegador
   - Parsear para obtener: browser, OS, device type

5. **Referer:**
   - URL de donde vino (si existe)
   - Ejemplo: "https://www.facebook.com/"

6. **Landing Page:**
   - Primera p√°gina que visit√≥
   - Ejemplo: "/precios"

**Session ID Management:**

Generar o reusar session_id con cookie:
- Si NO existe cookie `visitor_session_id` ‚Üí Generar nuevo UUID
- Si S√ç existe ‚Üí Reusar mismo session_id
- Cookie dura 30 d√≠as
- Permite rastrear m√∫ltiples visitas del mismo usuario

**Performance cr√≠tica:**

El middleware NO debe bloquear la carga de la p√°gina. Soluci√≥n:
- Guardar datos de tracking en **background** (fire-and-forget)
- Si el INSERT a Supabase falla, no importa (no fallar el request del usuario)
- Timeout de 100ms m√°ximo para tracking

**Rutas excluidas:**

NO trackear:
- `/api/*` (rutas de API)
- `/admin/*` (panel de admin)
- `/_next/*` (assets de Next.js)
- `/static/*` (archivos est√°ticos)

Solo trackear rutas p√∫blicas donde realmente hay usuarios navegando.

### Componente 2: Visitor Tracker

**Funci√≥n:** `trackVisitor(data)`

**L√≥gica:**

1. **Primera visita:**
   - No existe el session_id en la tabla
   - INSERT nuevo registro con todos los datos
   - pages_visited = 1

2. **Visita subsecuente (mismo usuario):**
   - Ya existe el session_id
   - UPDATE registro:
     - pages_visited += 1
     - last_visit_at = NOW()
     - exit_page = p√°gina actual
     - time_on_site = diferencia entre first_visit_at y NOW()

**Beneficio:** Puedes ver:
- "Usuario de Espa√±a visit√≥ 8 p√°ginas en 12 minutos"
- "Landing page: /precios, Exit page: /checkout"

### Componente 3: Webhook de Stripe

**Prop√≥sito:** Vincular visitas con compras.

**Flujo:**

1. Usuario completa compra en Stripe Checkout
2. Stripe env√≠a webhook `checkout.session.completed`
3. Tu endpoint recibe el evento
4. Extrae `session_id` de metadata de Stripe
5. UPDATE en `visitor_tracking`:
   - purchased = TRUE
   - purchase_id = payment_intent_id
   - purchase_amount_cents = amount_total
   - purchase_date = NOW()

**Requisito previo:**

Cuando crees el Stripe Checkout Session, debes pasar el `visitor_session_id` en metadata:

```
metadata: {
  visitor_session_id: cookieValue
}
```

Esto permite vincular la compra con la visita original.

### Librer√≠a recomendada: `ua-parser-js`

Para parsear User Agent strings de forma precisa:
- Detecta correctamente: Chrome, Safari, Firefox, Edge, etc.
- Detecta OS: Windows, macOS, iOS, Android, Linux
- Detecta device: desktop, mobile, tablet

Alternativa: Implementar parsing manual con regex (m√°s simple pero menos preciso).

---

## üó∫Ô∏è FASE 3: COMPONENTE GEO-ANALYTICS TAB

**Tiempo:** 3-4 horas  
**Estado:** ‚è≥ Pendiente  
**Dependencias:** Fase 1, 2

### Objetivo:
Crear un nuevo tab en el Dashboard de Admin con visualizaci√≥n geogr√°fica.

### Estructura de Navegaci√≥n:

Actualmente tienes:
```
/admin/dashboard
/admin/usuarios
/admin/compras
```

Agregar:
```
/admin/geo-analytics  ‚Üê NUEVO
```

### Layout del Tab:

**Secci√≥n 1: Header con t√≠tulo y filtros de fecha**

- T√≠tulo: "Geo-Analytics" con √≠cono de globo
- Subt√≠tulo: "An√°lisis geogr√°fico de tr√°fico y conversiones por pa√≠s"
- Filtros de rango: "7 d√≠as", "30 d√≠as", "90 d√≠as" (botones toggle)
- Dise√±o glassmorphism consistente con Dashboard de Compras

**Secci√≥n 2: 4 Cards de M√©tricas Globales**

Grid de 2x2 o 4 columnas, cada card con:

1. **Card "Visitas Totales"**
   - √çcono: Users (üë•)
   - Valor: N√∫mero total de visitas en el per√≠odo
   - Cambio: "+12.5%" vs per√≠odo anterior
   - Color: Azul
   - Tooltip: "Total de sesiones √∫nicas registradas"

2. **Card "Compras"**
   - √çcono: ShoppingCart (üõí)
   - Valor: N√∫mero de compras
   - Cambio: "+8.3%" vs per√≠odo anterior
   - Color: Verde
   - Tooltip: "Visitantes que completaron una compra"

3. **Card "Conversion Rate"**
   - √çcono: TrendingUp (üìà)
   - Valor: Porcentaje de conversi√≥n global
   - Cambio: "-0.2%" vs per√≠odo anterior
   - Color: Morado
   - Tooltip: "Compras / Visitas * 100"

4. **Card "Pa√≠ses Alcanzados"**
   - √çcono: Globe (üåç)
   - Valor: N√∫mero de pa√≠ses √∫nicos
   - Info extra: "Top: Espa√±a" (pa√≠s con m√°s visitas)
   - Color: Naranja
   - Tooltip: "Pa√≠ses desde donde se conectaron"

**Secci√≥n 3: Mapa Interactivo**

T√≠tulo: "Mapa de Conversiones Global"

Caracter√≠sticas del mapa:
- Librer√≠a: Leaflet (open-source) o Mapbox (premium)
- Tema: Dark mode (consistente con tu dise√±o)
- Tiles: CartoDB Dark Matter (gratuito, se ve profesional)
- Vista inicial: Centrado en el mundo, zoom para ver todos los pa√≠ses

**Markers por pa√≠s:**
- **Forma:** C√≠rculos (no pins tradicionales)
- **Tama√±o:** Proporcional al n√∫mero de visitas
  - F√≥rmula: `radio = min(max(visitas / 100, 5), 30)`
  - M√≠nimo 5px, m√°ximo 30px
- **Color:** Seg√∫n conversion rate
  - Verde (üü¢): ‚â•2% conversion (excelente)
  - Amarillo (üü°): 1-2% conversion (promedio)
  - Rojo (üî¥): <1% conversion (mejorable)
- **Borde:** Blanco, 2px, para contraste

**Interactividad:**
- **Hover:** Highlight del marker
- **Click:** Selecciona el pa√≠s y actualiza la tabla de abajo
- **Popup:** Al hacer click, mostrar tooltip con:
  - Nombre del pa√≠s
  - Visitas: X,XXX
  - Compras: XX
  - Conv. Rate: X.XX%

**Leyenda del mapa:**
Posici√≥n: Esquina inferior derecha
Contenido:
- "Tasa de Conversi√≥n"
- üü¢ ‚â• 2% (Alta)
- üü° 1-2% (Media)
- üî¥ < 1% (Baja)
- Fondo semi-transparente

**Secci√≥n 4: Tabla de Pa√≠ses**

T√≠tulo: "Estad√≠sticas por Pa√≠s"

Columnas:
1. **Bandera + Pa√≠s**
   - Emoji de bandera (üá™üá∏, üá∫üá∏, üá≤üáΩ)
   - Nombre completo del pa√≠s
   
2. **Visitas**
   - N√∫mero formateado (3,245)
   
3. **Compras**
   - N√∫mero simple (23)
   
4. **Conversion Rate**
   - Porcentaje con color:
     - Verde si ‚â•2%
     - Amarillo si 1-2%
     - Rojo si <1%
   - Flecha de tendencia (‚Üë/‚Üì/‚Üí)

5. **Revenue**
   - Monto en USD: $6,789.00
   
6. **Avg. Time**
   - Tiempo promedio en sitio: "3m 45s"

**Funcionalidades de la tabla:**
- Ordenamiento por cualquier columna (click en header)
- B√∫squeda por nombre de pa√≠s
- Paginaci√≥n si hay >20 pa√≠ses
- Highlight del pa√≠s seleccionado en mapa
- Export a CSV (bonus)

**Sincronizaci√≥n Mapa ‚Üî Tabla:**
- Click en pa√≠s en mapa ‚Üí Scroll autom√°tico a ese pa√≠s en tabla + highlight
- Click en fila de tabla ‚Üí Zoom del mapa a ese pa√≠s

---

## üìä FASE 4: M√âTRICAS Y TABLAS AVANZADAS

**Tiempo:** 2 horas  
**Estado:** ‚è≥ Pendiente  
**Dependencias:** Fase 3

### Objetivo:
A√±adir visualizaciones adicionales y comparativas.

### Secci√≥n 5: Top 5 Pa√≠ses

**Formato:** Cards horizontales con ranking

Cada card muestra:
1. **Medalla:** ü•á ü•à ü•â (top 3) o n√∫mero (4, 5)
2. **Bandera + Pa√≠s**
3. **Barra de progreso horizontal**
   - Ancho proporcional al % del total
   - Color seg√∫n posici√≥n (degradado)
4. **M√©tricas:**
   - Visitas: X,XXX (XX% del total)
   - Revenue: $X,XXX

**Ordenamiento:** Por defecto por visitas, opci√≥n de cambiar a revenue o conversion rate.

### Secci√≥n 6: Gr√°fico de Tendencias

**Tipo:** Line Chart (Recharts)

**Datos:**
- Eje X: √öltimos 30 d√≠as
- Eje Y: N√∫mero de visitas
- L√≠neas:
  - Total de visitas (azul)
  - Visitas que compraron (verde)
  - Gap entre l√≠neas muestra la conversi√≥n

**Interactividad:**
- Tooltip al hacer hover mostrando fecha y valores exactos
- Zoom en rango de fechas
- Toggle para mostrar/ocultar l√≠neas

### Secci√≥n 7: Breakdown por Dispositivo

**Formato:** 3 Cards peque√±as

1. **Desktop**
   - √çcono: Monitor
   - Visitas: X,XXX (XX%)
   - Conversion: X.XX%

2. **Mobile**
   - √çcono: Smartphone
   - Visitas: X,XXX (XX%)
   - Conversion: X.XX%

3. **Tablet**
   - √çcono: Tablet
   - Visitas: X,XXX (XX%)
   - Conversion: X.XX%

**Insight autom√°tico:**
Ejemplo: "‚ö†Ô∏è Mobile tiene 60% de tr√°fico pero solo 0.5% conversion. Revisar UX m√≥vil."

---

## üéØ FASE 5: CAMPA√ëAS Y UTM TRACKING

**Tiempo:** 2-3 horas  
**Estado:** ‚è≥ Pendiente  
**Dependencias:** Fase 4

### Objetivo:
Responder: "¬øMi campa√±a de Facebook funciona?"

### Secci√≥n 8: Vista de Campa√±as

**Layout:** Lista de cards expandibles

Cada card de campa√±a muestra:

**Header de la campa√±a:**
- Nombre: "Spain Targeting 2025"
- Source: Facebook
- Status: üü¢ Active / ‚è∏Ô∏è Paused / ‚úÖ Completed
- Fechas: 1 Oct - 31 Oct 2025

**Funnel Visual (3 columnas):**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  REACH (Facebook)                       ‚îÇ
‚îÇ  10,000 usuarios                        ‚îÇ
‚îÇ  Seg√∫n dashboard de Facebook            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì CTR: 32.45%
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  VISITAS (Tu web)                       ‚îÇ
‚îÇ  3,245 visitantes                       ‚îÇ
‚îÇ  Tracking real de tu servidor           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì Conversion: 0.71%
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  COMPRAS (Stripe)                       ‚îÇ
‚îÇ  23 compras                             ‚îÇ
‚îÇ  Revenue: $6,789                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**M√©tricas Financieras (4 columnas):**

1. **Gastado**
   - $500.00
   - (external_spend_cents de Facebook)

2. **Revenue**
   - $6,789.00
   - (suma de todas las compras de esta campa√±a)

3. **CAC** (Customer Acquisition Cost)
   - $21.74
   - F√≥rmula: Gastado / Compras = $500 / 23

4. **ROAS** (Return on Ad Spend)
   - 13.6x
   - F√≥rmula: Revenue / Gastado = $6,789 / $500
   - Color: Verde si ‚â•3x, Amarillo si 2-3x, Rojo si <2x

**Breakdown por Pa√≠s (tabla colapsable):**

Mostrar qu√© pa√≠ses fueron alcanzados por esta campa√±a:
- Espa√±a: 2,890 visitas, 18 compras, 0.62% conv
- M√©xico: 245 visitas, 3 compras, 1.22% conv
- Colombia: 110 visitas, 2 compras, 1.82% conv

**Insights autom√°ticos:**

Ejemplos de mensajes que el sistema puede generar:
- ‚úÖ "ROAS de 13.6x indica campa√±a muy rentable"
- ‚ö†Ô∏è "Colombia tiene mejor conversion (1.82%) que Espa√±a (0.62%). Considera aumentar presupuesto en Colombia."
- üöÄ "32.45% CTR est√° por encima del promedio de la industria (1-2%)"
- ‚ùå "Solo 23 compras de 3,245 visitas. Revisar p√°gina de checkout."

### Formulario: Crear Nueva Campa√±a

**Campos:**

1. **Nombre de campa√±a**
   - Ej: "Black Friday M√©xico 2025"

2. **UTM Source**
   - Dropdown: Facebook, Google, Instagram, TikTok, Email, Custom

3. **UTM Campaign**
   - Text input: "black_friday_mx_2025"

4. **Pa√≠ses objetivo**
   - Multi-select: ES, MX, CO, AR, etc.

5. **Presupuesto**
   - Input: $500.00

6. **Metas (opcionales):**
   - Reach esperado: 10,000
   - Visitas esperadas: 3,000
   - Compras esperadas: 30

7. **Datos externos (se llenan luego):**
   - Reach real (de Facebook): 10,500
   - Impressions: 45,000
   - Clicks: 3,500
   - Spend real: $487.50

**Output:** URL pre-formada para usar en Facebook Ads

```
https://apidevs.io/precios?utm_source=facebook&utm_medium=cpc&utm_campaign=black_friday_mx_2025
```

### Comparador de Campa√±as

**Vista:** Tabla comparativa de todas las campa√±as

Columnas:
- Campa√±a
- Source
- Reach ‚Üí Visitas ‚Üí Compras (funnel compacto)
- CTR
- Conversion
- CAC
- ROAS
- Status

**Ordenamiento:** Por defecto por ROAS (las m√°s rentables arriba)

**Filtros:**
- Por source (solo Facebook, solo Google, etc.)
- Por status (solo activas)
- Por rango de fechas

---

## ‚úÖ FASE 6: TESTING Y FINALIZACI√ìN

**Tiempo:** 1-2 horas  
**Estado:** ‚è≥ Pendiente  
**Dependencias:** Todas las anteriores

### Objetivo:
Asegurar que todo funciona correctamente y documentar.

### Testing Manual:

**Test 1: Tracking de Visitas**
1. Abrir tu web en inc√≥gnito
2. Visitar con `?utm_source=test&utm_campaign=manual_test`
3. Navegar 3-4 p√°ginas
4. Verificar en Supabase:
   - Registro en `visitor_tracking` con session_id
   - UTM params guardados correctamente
   - pages_visited = 3 o 4
   - Geolocalizaci√≥n detectada

**Test 2: Vinculaci√≥n con Compra**
1. Continuar sesi√≥n anterior
2. Completar una compra de prueba
3. Verificar webhook de Stripe ejecutado
4. Verificar en Supabase:
   - purchased = TRUE
   - purchase_id vinculado
   - purchase_amount correcto

**Test 3: Dashboard Visual**
1. Abrir `/admin/geo-analytics`
2. Verificar que carga sin errores
3. Verificar mapa muestra pa√≠ses
4. Click en pa√≠s, verificar sincronizaci√≥n con tabla
5. Probar filtros de fecha
6. Verificar m√©tricas calculadas correctamente

**Test 4: Campa√±as**
1. Crear campa√±a de prueba
2. Generar URL con UTMs
3. Visitar con esa URL
4. Verificar que la visita se asocia a la campa√±a
5. Verificar m√©tricas de campa√±a se actualizan

### Casos Edge a Verificar:

1. **Usuario sin JavaScript:** ¬øSe trackea igual? (S√≠, es server-side)
2. **Usuario con VPN:** ¬øGeolocalizaci√≥n incorrecta? (Inevitable, informar limitaci√≥n)
3. **Usuario con AdBlock:** ¬øSe trackea? (S√≠, no usa cookies de terceros)
4. **M√∫ltiples pesta√±as abiertas:** ¬øSe cuenta como 1 o m√∫ltiples visitas? (1, mismo session_id)
5. **Session cookie borrada:** ¬øQu√© pasa? (Se genera nuevo session_id, cuenta como nuevo visitante)

### Performance Testing:

**Objetivo:** El middleware NO debe a√±adir latencia perceptible.

1. Medir tiempo de respuesta SIN tracking
2. Medir tiempo de respuesta CON tracking
3. Diferencia debe ser <50ms
4. Si es mayor, optimizar (mover tracking a background job)

### Documentaci√≥n a Crear:

**Archivo 1: `GEO-ANALYTICS.md`** (este documento)
- Explicaci√≥n completa del sistema
- Arquitectura
- Esquema de base de datos

**Archivo 2: `GEO-ANALYTICS-USAGE.md`**
- C√≥mo usar el dashboard
- C√≥mo crear campa√±as
- C√≥mo interpretar m√©tricas
- FAQ

**Archivo 3: Comentarios en c√≥digo**
- Explicar funciones complejas
- Documentar decisiones de dise√±o

---

## üéì CONCEPTOS CLAVE PARA ENTENDER

### 1. ¬øQu√© es un UTM Parameter?

UTM = Urchin Tracking Module (de Google Analytics)

Son par√°metros que a√±ades a tus URLs para saber de d√≥nde vino el tr√°fico:

```
https://tusite.com/producto?utm_source=facebook&utm_campaign=verano2025
```

**Los 5 UTM est√°ndar:**
- `utm_source`: De qu√© plataforma (facebook, google, instagram)
- `utm_medium`: Tipo de tr√°fico (cpc, email, social)
- `utm_campaign`: Nombre de campa√±a (verano2025, black_friday)
- `utm_term`: Palabra clave (solo para Google Ads)
- `utm_content`: Variante del anuncio (ad_a, ad_b)

### 2. ¬øQu√© es Geolocalizaci√≥n por IP?

Cada dispositivo conectado a internet tiene una IP √∫nica.
Servicios como MaxMind mantienen bases de datos gigantes que mapean:
- IP 89.116.30.133 ‚Üí Espa√±a, Madrid, lat: 40.4165, lng: -3.7026

Vercel/Cloudflare ya hacen esto autom√°ticamente en sus servidores.
Tu c√≥digo solo tiene que leer los headers.

**Precisi√≥n:**
- Pa√≠s: ~99% preciso
- Ciudad: ~75-80% preciso
- Coordenadas: ~20-50km de error

**Limitaci√≥n:** VPNs reportan el pa√≠s del servidor VPN, no del usuario real.

### 3. ¬øQu√© es un Session ID?

Identificador √∫nico por visitante para rastrear m√∫ltiples visitas.

**Ejemplo:**
```
Session ID: 1727876543210-xyz789abc
  Visita 1: 2 Oct 10:30am ‚Üí /inicio
  Visita 2: 2 Oct 10:32am ‚Üí /precios
  Visita 3: 2 Oct 10:35am ‚Üí /checkout
  Compra:   2 Oct 10:40am ‚Üí ‚úÖ $390
```

Sin session_id, cada visita parecer√≠a un usuario diferente.

**Almacenamiento:** Cookie HTTP-only (no accesible desde JavaScript, m√°s seguro).

### 4. ¬øQu√© es CAC y ROAS?

**CAC** (Customer Acquisition Cost):
- Cu√°nto gastas para conseguir 1 cliente
- F√≥rmula: Gasto de publicidad / N√∫mero de clientes
- Ejemplo: $500 / 23 clientes = $21.74 por cliente
- **Objetivo:** Que sea menor que el LTV (valor de vida del cliente)

**ROAS** (Return on Ad Spend):
- Cu√°ntos d√≥lares ganas por cada d√≥lar gastado
- F√≥rmula: Revenue / Gasto de publicidad
- Ejemplo: $6,789 / $500 = 13.6x
- **Interpretaci√≥n:**
  - <1x = Pierdes dinero
  - 1-2x = Breakeven o ganancia m√≠nima
  - 2-3x = Bueno
  - 3-5x = Muy bueno
  - >5x = Excelente

### 5. ¬øQu√© es una Vista Materializada?

Tabla "virtual" que almacena resultados pre-calculados de queries complejas.

**Sin vista materializada:**
```sql
SELECT country, COUNT(*), AVG(conversion_rate)
FROM visitor_tracking
WHERE created_at > NOW() - INTERVAL '30 days'
GROUP BY country;
-- Tarda 2 segundos con 1 mill√≥n de registros
```

**Con vista materializada:**
```sql
SELECT * FROM country_stats;
-- Tarda 0.05 segundos (ya est√° calculado)
```

**Trade-off:**
- ‚úÖ Mucho m√°s r√°pido
- ‚ùå Datos ligeramente desactualizados (se refresca cada hora)

Para dashboards de analytics, es perfecto (no necesitas datos en tiempo real al segundo).

---

## üéØ RESULTADO FINAL ESPERADO

### Dashboard Geo-Analytics Completo:

Usuario administrador accede a `/admin/geo-analytics` y ve:

**Pantalla 1: Overview Global**
- 4 m√©tricas globales en cards
- Mapa interactivo con pins de pa√≠ses
- Tabla con top pa√≠ses
- Selector de rango de fechas

**Pantalla 2: Campa√±as (tab aparte o secci√≥n abajo)**
- Lista de campa√±as activas
- Cada campa√±a muestra funnel completo
- M√©tricas CAC y ROAS
- Comparador de campa√±as

### Flujo de Uso Real:

**Caso 1: Lanzar campa√±a en Facebook**

1. Vas a `/admin/geo-analytics/campanas`
2. Click "Nueva Campa√±a"
3. Llenas formulario:
   - Nombre: "Promoci√≥n Espa√±a Octubre"
   - Source: Facebook
   - Campaign: "promo_es_oct_2025"
   - Pa√≠ses: Espa√±a
   - Presupuesto: $500
4. Sistema genera URL:
   ```
   https://apidevs.io?utm_source=facebook&utm_campaign=promo_es_oct_2025
   ```
5. Copias esa URL a Facebook Ads Manager
6. Lanzas la campa√±a

**Una semana despu√©s:**

7. Vuelves a `/admin/geo-analytics`
8. Ves:
   - Facebook reporta: 8,500 reach
   - Tu web registra: 2,890 visitas (34% CTR)
   - Compras: 18 (0.62% conversion)
   - Revenue: $5,234
   - CAC: $27.78
   - ROAS: 10.5x ‚úÖ

9. **Decisi√≥n informada:**
   - ROAS de 10.5x es excelente ‚Üí Aumentar presupuesto
   - CTR de 34% es muy alto ‚Üí El anuncio funciona
   - Conversion de 0.62% es mejorable ‚Üí Revisar landing page

**Caso 2: Comparar pa√≠ses**

1. Entras a la tabla de pa√≠ses
2. Ordenas por "Conversion Rate"
3. Descubres:
   - Colombia: 1.82% conversion con solo 110 visitas
   - Espa√±a: 0.62% conversion con 2,890 visitas
4. **Insight:** Colombia convierte mejor pero tiene poco tr√°fico
5. **Acci√≥n:** Lanzar campa√±a espec√≠fica para Colombia

### M√©tricas de √âxito:

Al finalizar la implementaci√≥n, debes poder responder:

‚úÖ **"¬øCu√°ntos visitantes tengo por pa√≠s?"**
- Respuesta: Tabla ordenada + mapa visual

‚úÖ **"¬øQu√© pa√≠ses compran m√°s?"**
- Respuesta: Conversion rate por pa√≠s, colores en mapa

‚úÖ **"¬øMi campa√±a de Facebook funciona?"**
- Respuesta: Funnel completo, CAC, ROAS

‚úÖ **"¬øVale la pena invertir en publicidad en X pa√≠s?"**
- Respuesta: Comparativa de pa√≠ses con m√©tricas financieras

‚úÖ **"¬øCu√°nto dinero gener√© de cada campa√±a?"**
- Respuesta: Revenue por campa√±a + ROAS

---

## üîß DEPENDENCIAS T√âCNICAS

### Librer√≠as NPM a Instalar:

1. **`@vercel/functions`**
   - Para: ipAddress() y geolocation()
   - Solo funciona en Vercel (tu hosting)

2. **`leaflet`** + **`react-leaflet`**
   - Para: Mapa interactivo
   - Alternativa: Mapbox (requiere API key de pago)

3. **`ua-parser-js`** (opcional)
   - Para: Parsear User Agent strings
   - Alternativa: Regex manual (m√°s simple, menos preciso)

4. **Recharts** (ya lo tienes)
   - Para: Gr√°ficos de tendencias

### Variables de Entorno Necesarias:

```env
# Stripe (ya las tienes)
STRIPE_SECRET_KEY=sk_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Supabase (ya las tienes)
NEXT_PUBLIC_SUPABASE_URL=https://...
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
```

No se requieren APIs adicionales (Vercel geo es gratuito).

---

## üìã CHECKLIST DE IMPLEMENTACI√ìN

### Fase 1: Base de Datos ‚úÖ
- [ ] Crear tabla `visitor_tracking`
- [ ] Crear tabla `utm_campaigns`
- [ ] Crear vista `campaign_performance`
- [ ] Crear vista `country_stats`
- [ ] Crear √≠ndices optimizados
- [ ] Crear triggers de actualizaci√≥n

### Fase 2: Tracking ‚úÖ
- [ ] Implementar middleware Next.js
- [ ] Capturar IP y geolocalizaci√≥n
- [ ] Parsear User Agent
- [ ] Extraer UTM parameters
- [ ] Generar/gestionar session_id
- [ ] Implementar visitor tracker
- [ ] Crear webhook de Stripe
- [ ] Probar tracking end-to-end

### Fase 3: UI Base ‚úÖ
- [ ] Crear ruta `/admin/geo-analytics`
- [ ] Implementar componente GeoAnalyticsTab
- [ ] 4 cards de m√©tricas globales
- [ ] Integrar Leaflet/Mapbox
- [ ] Implementar mapa con markers
- [ ] Colorear markers seg√∫n conversion
- [ ] Popups con informaci√≥n
- [ ] Leyenda del mapa

### Fase 4: Tablas y Visualizaciones ‚úÖ
- [ ] Tabla de pa√≠ses con estad√≠sticas
- [ ] Ordenamiento por columnas
- [ ] Sincronizaci√≥n mapa ‚Üî tabla
- [ ] Top 5 pa√≠ses (ranking)
- [ ] Gr√°fico de tendencias
- [ ] Breakdown por dispositivo

### Fase 5: Campa√±as ‚úÖ
- [ ] Vista de lista de campa√±as
- [ ] Card de campa√±a con funnel
- [ ] M√©tricas CAC y ROAS
- [ ] Formulario crear campa√±a
- [ ] Generador de URLs con UTMs
- [ ] Comparador de campa√±as
- [ ] Insights autom√°ticos

### Fase 6: Testing ‚úÖ
- [ ] Test tracking de visitas
- [ ] Test vinculaci√≥n con compras
- [ ] Test dashboard visual
- [ ] Test campa√±as
- [ ] Performance testing
- [ ] Documentaci√≥n
- [ ] Deploy a producci√≥n

---

## üöÄ PR√ìXIMOS PASOS DESPU√âS DE IMPLEMENTAR

### Mejoras Futuras (Fase 7+):

1. **Heatmaps de clicks**
   - Ver d√≥nde hacen click los usuarios
   - Librer√≠a: Hotjar o implementaci√≥n custom

2. **Grabaci√≥n de sesiones**
   - Ver c√≥mo navegan los usuarios
   - Librer√≠a: LogRocket, FullStory

3. **A/B Testing integrado**
   - Probar variantes de p√°ginas
   - Medir cu√°l convierte mejor

4. **Alertas autom√°ticas**
   - Email cuando ROAS <2x
   - Email cuando pa√≠s nuevo con buena conversion
   - Email cuando campa√±a supera meta

5. **Predicciones con ML**
   - Predecir qu√© pa√≠ses convertir√°n mejor
   - Sugerir presupuestos √≥ptimos

6. **Integraci√≥n directa con Facebook API**
   - Importar autom√°ticamente reach e impressions
   - No llenar manualmente los datos externos

7. **Dashboard p√∫blico para clientes**
   - Versi√≥n simplificada sin datos sensibles
   - Mostrar solo sus campa√±as

---

## üí° CONSEJOS DE IMPLEMENTACI√ìN

### 1. Empezar Simple
No implementes todo de golpe. Orden recomendado:
1. Base de datos (Fase 1)
2. Tracking b√°sico (Fase 2)
3. Vista simple con tabla (parte de Fase 3)
4. Mapa (resto de Fase 3)
5. Campa√±as (Fase 5)

### 2. Datos de Prueba
Antes de tener tr√°fico real, genera datos fake para desarrollar:
- 10,000 visitas aleatorias
- 50 pa√≠ses diferentes
- 100 compras
- 3-4 campa√±as

Script SQL para insertar datos de prueba (te lo puedo dar despu√©s).

### 3. Performance
- Usar vistas materializadas para queries lentas
- Refrescar vistas con cron job (cada hora)
- √çndices en TODAS las columnas que uses en WHERE
- Limitar queries a √∫ltimos 90 d√≠as por defecto

### 4. Privacidad
- Nunca mostrar IPs individuales en el dashboard
- Solo agregaciones (totales por pa√≠s)
- Cumplir GDPR: No guardar IPs >30 d√≠as (campo `ip_address`)
- Permitir opt-out con cookie `do-not-track`

### 5. Testing
- Usar `utm_source=test` para tus pruebas
- Filtrar visitas de admin del dashboard (tu IP)
- Verificar webhooks de Stripe en modo test

---

## üéâ CONCLUSI√ìN

Este sistema te dar√° **visibilidad completa** del journey de tus usuarios:

```
Anuncio (Facebook) 
  ‚Üí Visita (tu web) 
    ‚Üí Navegaci√≥n (p√°ginas) 
      ‚Üí Compra (Stripe) 
        ‚Üí Analytics (este dashboard)
```

Por primera vez, podr√°s responder con **datos reales**:
- ¬øFuncionan mis anuncios?
- ¬øQu√© pa√≠ses son m√°s rentables?
- ¬øCu√°nto cuesta conseguir un cliente?
- ¬øVale la pena seguir invirtiendo en publicidad?

**Valor de Negocio:**
- Optimizar presupuesto de ads
- Identificar pa√≠ses con mejor ROI
- Detectar problemas de conversi√≥n
- Justificar gastos de marketing con datos

**Ventaja Competitiva:**
Mientras otros negocios solo ven datos de Facebook/Google (reach, impressions), t√∫ ver√°s la verdad completa de qu√© pasa en TU web.

---

**üöÄ ¬°Listo para implementar!**

Este documento es la gu√≠a completa. Cada fase tiene objetivos claros y resultados esperados. Puedes entreg√°rselo a otro desarrollador y podr√° implementarlo siguiendo este plan.

**Tiempo total estimado:** 12-15 horas de desarrollo
**Complejidad:** Media-Alta
**Valor de negocio:** MUY ALTO üí∞
